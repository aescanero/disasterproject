---
- name: Change file ownership, group and permissions
  delegate_to: localhost
  run_once: true
  file:
    path: "{{ ansible_ssh_private_key_file }}"
    mode: '0600'

- name: Wait for start to complete
  wait_for_connection:
    connect_timeout: 20
    sleep: 10
    delay: 5
    timeout: 300
  vars:
    ansible_host: "{{ vm_ip }}"
    warn: false

- name: Obtain vm information
  setup:
  vars:
    ansible_host: "{{ vm_ip }}"
    warn: false

- name: Hostname Configuration
  command: hostnamectl set-hostname "{{ inventory_hostname }}"
  vars:
    ansible_host: "{{ vm_ip }}"

- name: Make sure old host conf is not in the hosts configuration
  lineinfile:
    path: /etc/hosts
    state: absent
    regexp: '#Added by Ansible os role'
  vars:
    ansible_host: "{{ vm_ip }}"

- name: Update /etc/hosts
  lineinfile:
    path: /etc/hosts
    insertbefore: BOF
    line: '{{ hostvars[item].ansible_default_ipv4.address }} {{ hostvars[item].ansible_facts.hostname }} {{ hostvars[item].ansible_facts.fqdn }} #Added by Ansible os role'
  with_items: "{{ hostvars }}"
  vars:
    ansible_host: "{{ vm_ip }}"

- name: Update repositories cache and install nfs-client
  apt:
    name: nfs-common
    force_apt_get: True
  when: ansible_os_family == "Debian"
  vars:
    ansible_host: "{{ vm_ip }}"
    warn: false

- name: Update repositories cache and install nfs-client
  yum:
    name: nfs-utils
    state: latest
  when: ansible_os_family == "Redhat"
  vars:
    ansible_host: "{{ vm_ip }}"
...
